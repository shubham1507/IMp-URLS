import * as React from "react";
import Box from "@mui/material/Box";
import Divider from "@mui/material/Divider";
import List from "@mui/material/List";
import ListItem from "@mui/material/ListItem";
import MenuItem from "@mui/material/MenuItem";
import Popover from "@mui/material/Popover";
import Typography from "@mui/material/Typography";
import { User as UserIcon } from "@phosphor-icons/react/dist/ssr/User";
import { LockKey as LockKeyIcon } from "@phosphor-icons/react/dist/ssr/LockKey";

import { paths } from "@/paths";
import { RouterLink } from "@/components/core/link";

// Staff id from env (optional, no hardcoding)
const STAFF_ID_FROM_ENV = import.meta.env.VITE_STAFF_ID || "";

// âœ… Same sign-out behavior as original code
function SignOutButton() {
  return (
    <MenuItem
      component="a"
      href="/sign-out"
      sx={{ justifyContent: "center" }}
    >
      Sign out
    </MenuItem>
  );
}

const initialUser = {
  id: "",
  name: "User",
  avatar: "/assets/avatar-3.png",
  email: "",
};

export function UserPopover({ anchorEl, onClose, open }) {
  const [user, setUser] = React.useState(initialUser);
  const [loading, setLoading] = React.useState(false);

  React.useEffect(() => {
    let baseUrl = import.meta.env.VITE_API_GATEWAY_URL;

    if (!baseUrl) {
      console.error("[UserPopover] VITE_API_GATEWAY_URL is not set");
      return;
    }

    baseUrl = baseUrl.replace(/\/$/, "");

    // ---- Dynamically resolve staffId ----
    let staffId: string | null = null;

    // 1) Highest priority: env (useful in local dev)
    if (STAFF_ID_FROM_ENV) {
      staffId = STAFF_ID_FROM_ENV;
    }

    // 2) Try localStorage.user
    if (!staffId) {
      try {
        const rawUser = window.localStorage.getItem("user");
        if (rawUser) {
          const parsed = JSON.parse(rawUser);
          staffId =
            parsed.staff_id ||
            parsed.staffId ||
            parsed.qcid ||
            parsed.qc_id ||
            parsed.id ||
            null;
        }
      } catch (e) {
        console.error("[UserPopover] Failed to parse localStorage.user", e);
      }
    }

    // 3) Try localStorage.session
    if (!staffId) {
      try {
        const rawSession = window.localStorage.getItem("session");
        if (rawSession) {
          const parsed = JSON.parse(rawSession);
          staffId =
            parsed.staff_id ||
            parsed.staffId ||
            parsed.qcid ||
            parsed.qc_id ||
            parsed.id ||
            null;
        }
      } catch (e) {
        console.error("[UserPopover] Failed to parse localStorage.session", e);
      }
    }

    // 4) Try decoding JWT token (access_token or token)
    if (!staffId) {
      try {
        const jwt =
          window.localStorage.getItem("access_token") ||
          window.localStorage.getItem("token");
        if (jwt && jwt.split(".").length === 3) {
          const payloadPart = jwt.split(".")[1];
          const jsonPayload = JSON.parse(
            atob(payloadPart.replace(/-/g, "+").replace(/_/g, "/"))
          );
          staffId =
            jsonPayload.staff_id ||
            jsonPayload.staffId ||
            jsonPayload.qcid ||
            jsonPayload.qc_id ||
            jsonPayload.sub ||
            null;
        }
      } catch (e) {
        console.error("[UserPopover] Failed to decode JWT for staff id", e);
      }
    }

    console.log("[UserPopover] Resolved staffId =", staffId);

    if (!staffId) {
      // No staff id => we can't call the profile API safely
      return;
    }

    const controller = new AbortController();

    async function fetchProfile() {
      try {
        setLoading(true);

        const url = `${baseUrl}/api/v1/users/${staffId}/profile`;
        console.log("[UserPopover] Fetching profile:", url);

        const token =
          window.localStorage.getItem("access_token") ||
          window.localStorage.getItem("token");

        const headers: Record<string, string> = {
          accept: "application/json",
        };

        if (token) {
          headers["Authorization"] = `Bearer ${token}`;
        }

        const res = await fetch(url, {
          method: "GET",
          headers,
          credentials: "include",
          signal: controller.signal,
        });

        if (!res.ok) {
          console.error(
            "[UserPopover] Failed to fetch user profile",
            res.status,
            res.statusText
          );
          return;
        }

        const data = await res.json();
        console.log("[UserPopover] profile response =", data);

        setUser({
          id: data?.staff_id ?? "",
          name: data?.display_name ?? "User",
          email: data?.email ?? "",
          avatar: "/assets/avatar-3.png",
        });
      } catch (err) {
        if (err.name !== "AbortError") {
          console.error("[UserPopover] Error fetching user profile", err);
        }
      } finally {
        setLoading(false);
      }
    }

    fetchProfile();
    return () => controller.abort();
  }, []);

  const handleClose = () => {
    if (onClose) {
      onClose();
    }
  };

  return (
    <Popover
      anchorEl={anchorEl}
      anchorOrigin={{ horizontal: "right", vertical: "bottom" }}
      onClose={handleClose}
      open={open}
      slotProps={{ paper: { sx: { width: 280 } } }}
      transformOrigin={{ horizontal: "right", vertical: "top" }}
    >
      {/* Top: name + email (same design) */}
      <Box sx={{ p: 2 }}>
        <Typography variant="subtitle1">
          {loading ? "Loading..." : user.name}
        </Typography>
        <Typography color="text.secondary" variant="body2">
          {loading ? "" : user.email}
        </Typography>
      </Box>

      <Divider />

      {/* Middle: Account + Settings */}
      <Box sx={{ p: 1 }}>
        <List>
          <ListItem
            component={RouterLink}
            href={paths.dashboard.profile.account}
            onClick={handleClose}
          >
            <UserIcon style={{ marginRight: 8 }} />
            Account
          </ListItem>

          <ListItem
            component={RouterLink}
            href={paths.dashboard.profile.settings}
            onClick={handleClose}
          >
            <LockKeyIcon style={{ marginRight: 8 }} />
            Settings
          </ListItem>
        </List>
      </Box>

      <Divider />

      {/* Bottom: Sign out */}
      <Box sx={{ p: 1 }}>
        <SignOutButton />
      </Box>
    </Popover>
  );
}