import * as React from 'react';
import Box from '@mui/material/Box';
import Divider from '@mui/material/Divider';
import List from '@mui/material/List';
import ListItem from '@mui/material/ListItem';
import MenuItem from '@mui/material/MenuItem';
import Popover from '@mui/material/Popover';
import Typography from '@mui/material/Typography';
import { CreditCard as CreditCardIcon } from '@phosphor-icons/react/dist/ssr/CreditCard';
import { LockKey as LockKeyIcon } from '@phosphor-icons/react/dist/ssr/LockKey';
import { User as UserIcon } from '@phosphor-icons/react/dist/ssr/User';

import { paths } from '@/paths';
import { RouterLink } from '@/components/core/link';
import { useSession } from '@/hooks/use-session';
import { signOut } from '@/lib/auth';

// ---- NEW: default user state (no more hard-coded Alice Smith) ----
const initialUser = {
  id: '',
  name: '',
  avatar: '/assets/avatar-3.png',
  email: '',
};

function SignOutButton() {
  return (
    <MenuItem
      component="button"
      onClick={() => {
        void signOut();
      }}
    >
      Sign out
    </MenuItem>
  );
}

export function UserPopover({ anchorEl, onClose, open }) {
  // session should already have the logged-in user info (incl. staff_id)
  const { user: sessionUser } = useSession();

  // local state for the user shown in the popover
  const [user, setUser] = React.useState(() => ({
    ...initialUser,
    id: sessionUser?.staff_id ?? initialUser.id,
    name:
      sessionUser?.name ??
      sessionUser?.display_name ??
      initialUser.name,
    email: sessionUser?.email ?? initialUser.email,
  }));

  // ---- NEW: fetch profile from your API using staff_id ----
  React.useEffect(() => {
    const staffId = sessionUser?.staff_id;

    if (!staffId) {
      return;
    }

    const controller = new AbortController();

    async function loadProfile() {
      try {
        const baseUrl = import.meta.env.VITE_API_GATEWAY_URL;
        if (!baseUrl) {
          console.error('VITE_API_GATEWAY_URL is not configured');
          return;
        }

        const res = await fetch(
          `${baseUrl}/api/v1/users/${staffId}/profile`,
          {
            method: 'GET',
            headers: { accept: 'application/json' },
            signal: controller.signal,
          }
        );

        if (!res.ok) {
          console.error('Failed to fetch user profile', res.status);
          return;
        }

        const data = await res.json();
        // sample response (from your screenshot):
        // { ok, staff_id, profile: { display_name, email, ... }, created, chaos_platform_role }

        setUser((prev) => ({
          ...prev,
          id: data?.staff_id ?? prev.id,
          name: data?.profile?.display_name ?? prev.name,
          email: data?.profile?.email ?? prev.email,
        }));
      } catch (err) {
        if (err.name === 'AbortError') return;
        console.error('Error fetching user profile', err);
      }
    }

    loadProfile();

    return () => controller.abort();
  }, [sessionUser?.staff_id]);

  const handleClose = () => {
    if (onClose) {
      onClose();
    }
  };

  return (
    <Popover
      anchorEl={anchorEl}
      anchorOrigin={{ horizontal: 'right', vertical: 'bottom' }}
      onClose={handleClose}
      open={open}
      slotProps={{ paper: { sx: { width: 280 } } }}
      transformOrigin={{ horizontal: 'right', vertical: 'top' }}
    >
      <Box sx={{ p: 2 }}>
        <Typography variant="subtitle1">
          {user.name || 'User'}
        </Typography>
        <Typography color="text.secondary" variant="body2">
          {user.email || 'Loading...'}
        </Typography>
      </Box>

      <Divider />

      <Box sx={{ p: 1 }}>
        <List>
          <ListItem
            component={RouterLink}
            href={paths.dashboard.profile.account}
            onClick={handleClose}
          >
            <UserIcon style={{ marginRight: 8 }} />
            Account
          </ListItem>
          <ListItem
            component={RouterLink}
            href={paths.dashboard.profile.settings}
            onClick={handleClose}
          >
            <LockKeyIcon style={{ marginRight: 8 }} />
            Settings
          </ListItem>
          <ListItem
            component={RouterLink}
            href={paths.dashboard.billing}
            onClick={handleClose}
          >
            <CreditCardIcon style={{ marginRight: 8 }} />
            Billing
          </ListItem>
        </List>
      </Box>

      <Divider />

      <Box sx={{ p: 1 }}>
        <SignOutButton />
      </Box>
    </Popover>
  );
}
